!function(e){"function"==typeof define&&define.amd?define(e):e()}(function(){"use strict";var e={},t={};AFRAME.registerComponent("gltf-part",{schema:{buffer:{default:!0},part:{type:"string"},src:{type:"asset"}},update:function(){var e=this.el;!this.data.part&&this.data.src||this.getModel(function(t){t&&e.setObject3D("mesh",t)})},getModel:function(i){var n=this;if(!t[this.data.src])return e[this.data.src]?e[this.data.src].then(function(e){i(n.selectFromModel(e))}):void(e[this.data.src]=new Promise(function(o){(new THREE.GLTFLoader).load(n.data.src,function(s){var a=s.scene||s.scenes[0];t[n.data.src]=a,delete e[n.data.src],i(n.selectFromModel(a)),o(a)},function(){},console.error)}));i(this.selectFromModel(t[this.data.src]))},selectFromModel:function(e){var t;if(t=e.getObjectByName(this.data.part))return t.clone();console.error("[gltf-part] `"+this.data.part+"` not found in model.")}}),function(){var e=AFRAME.utils.debug("components:materialx:error"),t=AFRAME.shaders;function i(e,t){e.dispose(),t.unregisterMaterial(e)}function n(e,t,i,n){var o=!1;if(n.length=0,0===i.length)return!0;if(""===t){(s=e.getObject3D("mesh"))&&s.material&&(n.push(s.material),s.material=i[0],o=!0)}else{var s=e.object3D,a=t.replace(/[\.\{\}\(\)\^\[\]\$]/g,"\\$&").replace(/[\*\?]/g,".$&"),r=new RegExp("^"+a+"$"),l=0;s&&s.traverse(function(e){if(e&&e.material)if(o=!0,Array.isArray(e.material))for(var t=0,s=e.material.length;t<s;t++)r.test(e.material[t].name)&&(n.push(e.material[t]),e.material[t]=i[l],l=(l+1)%i.length);else r.test(e.material.name)&&(n.push(e.material),e.material=i[l],l=(l+1)%i.length)})}return o}AFRAME.registerComponent("materialx",{schema:{alphaTest:{default:0,min:0,max:1},depthTest:{default:!0},depthWrite:{default:!0},flatShading:{default:!1},name:{default:""},npot:{default:!1},offset:{type:"vec2",default:{x:0,y:0}},opacity:{default:1,min:0,max:1},remap:{default:""},repeat:{type:"vec2",default:{x:1,y:1}},shader:{default:"standard",oneOf:Object.keys(AFRAME.shaders),schemaChange:!0},side:{default:"front",oneOf:["front","back","double"]},transparent:{default:!1},vertexColors:{type:"string",default:"none",oneOf:["face","vertex"]},visible:{default:!0},blending:{default:"normal",oneOf:["none","normal","additive","subtractive","multiply"]}},multiple:!0,init:function(){this.system=this.el.sceneEl.systems.material,this.material=null,this.oldMaterials=[]},update:function(e){var t=this.data;this.shader&&t.shader===e.shader||(n(this.el,e.remap,this.oldMaterials,[]),this.updateShader(t.shader)),this.shader.update(this.data),this.updateMaterial(e)},updateSchema:function(i){var n,o,s,a;o=i&&i.shader,n=this.oldData&&this.oldData.shader,(s=t[a=o||n]&&t[a].schema)||e("Unknown shader schema "+a),n&&o===n||(this.extendSchema(s),this.updateBehavior())},updateBehavior:function(){var e,t,i=this.el.sceneEl,n=this.schema,o=this;function s(e,i){var n;for(n in t)t[n]=e;o.shader.update(t)}for(e in this.tick=void 0,t={},n)"time"===n[e].type&&(this.tick=s,t[e]=!0);i&&(this.tick?i.addBehavior(this):i.removeBehavior(this))},updateShader:function(e){var i,n=this.data,o=t[e]&&t[e].Shader;if(!o)throw new Error("Unknown shader "+e);(i=this.shader=new o).el=this.el,i.init(n),this.setMaterial(i.material),this.updateSchema(n)},updateMaterial:function(e){var t,i=this.data,n=this.material;for(t in n.alphaTest=i.alphaTest,n.depthTest=!1!==i.depthTest,n.depthWrite=!1!==i.depthWrite,n.name=i.name,n.opacity=i.opacity,n.flatShading=i.flatShading,n.side=function(e){switch(e){case"back":return THREE.BackSide;case"double":return THREE.DoubleSide;default:return THREE.FrontSide}}(i.side),n.transparent=!1!==i.transparent||i.opacity<1,n.vertexColors=function(e){switch(e){case"face":return THREE.FaceColors;case"vertex":return THREE.VertexColors;default:return THREE.NoColors}}(i.vertexColors),n.visible=i.visible,n.blending=function(e){switch(e){case"none":return THREE.NoBlending;case"additive":return THREE.AdditiveBlending;case"subtractive":return THREE.SubtractiveBlending;case"multiply":return THREE.MultiplyBlending;default:return THREE.NormalBlending}}(i.blending),e)break;!t||e.alphaTest===i.alphaTest&&e.side===i.side&&e.vertexColors===i.vertexColors||(n.needsUpdate=!0)},remove:function(){var e=this.material;n(this.el,this.data.remap,this.oldMaterials,[]),this.oldMaterials.length=0,i(e,this.system)},setMaterial:function(e){var t=this.el,o=this.system,s=this.data.remap,a=this.oldMaterials;this.material&&i(this.material,o),this.material=e,o.registerMaterial(e),n(t,s,[e],a)||t.addEventListener("object3dset",function i(o){"mesh"===o.detail.type&&o.target===t&&(n(t,s,[e],a),t.removeEventListener("object3dset",i))})}})}();Object.freeze({x:0,y:0,z:0}),Object.freeze({x:1,y:0,z:0}),Object.freeze({x:0,y:1,z:0}),Object.freeze({x:0,y:0,z:1});const i=Math.sqrt(.5);Object.freeze({x:0,y:0,z:0,w:1}),Object.freeze({x:1,y:0,z:0,w:0}),Object.freeze({x:0,y:1,z:0,w:0}),Object.freeze({x:0,y:0,z:1,w:0}),Object.freeze({x:i,y:0,z:0,w:i}),Object.freeze({x:0,y:i,z:0,w:i}),Object.freeze({x:0,y:0,z:i,w:i});const n=function(){let e=new Float32Array(16);return function(t,i,n,o){if(i&&(i.x=t[12],i.y=t[13],i.z=t[14]),o||n){const i=Math.hypot(t[0],t[1],t[2]),s=Math.hypot(t[4],t[5],t[6]),a=Math.hypot(t[8],t[9],t[10]);if(o&&(o.x=i,o.y=s,o.z=a),n){const o=function(e){const t=e[0],i=e[1],n=e[2],o=e[4],s=e[5],a=e[6],r=e[8],l=e[9],h=e[10];return t*(h*s-a*l)+i*(a*r-h*o)+n*(l*o-s*r)}(t)<0?-1/i:1/i,r=1/s,l=1/a;e.set(t),e[0]*=o,e[1]*=o,e[2]*=o,e[4]*=r,e[5]*=r,e[6]*=r,e[8]*=l,e[9]*=l,e[10]*=l,function(e,t){const i=t[0],n=t[4],o=t[8],s=t[1],a=t[5],r=t[9],l=t[2],h=t[6],c=t[10],d=i+a+c;let u;d>0?(u=.5/Math.sqrt(d+1),e.w=.25/u,e.x=(h-r)*u,e.y=(o-l)*u,e.z=(s-n)*u):i>a&&i>c?(u=2*Math.sqrt(1+i-a-c),e.w=(h-r)/u,e.x=.25*u,e.y=(n+s)/u,e.z=(o+l)/u):a>c?(u=2*Math.sqrt(1+a-i-c),e.w=(o-l)/u,e.x=(n+s)/u,e.y=.25*u,e.z=(r+h)/u):(u=2*Math.sqrt(1+c-i-a),e.w=(s-n)/u,e.x=(o+l)/u,e.y=(r+h)/u,e.z=.25*u)}(n,e)}}return t}}(),o=function(){let e=new THREE.Vector3,t=new THREE.Quaternion,i=new THREE.Vector3,n=new THREE.Box3;return function(o,s){return 0===s.children.length?o:(e.copy(s.position),t.copy(s.quaternion),i.copy(s.scale),s.position.set(0,0,0),s.quaternion.set(0,0,0,1),s.scale.set(1,1,1),n.setFromObject(s),s.position.copy(e),s.quaternion.copy(t),s.scale.copy(i),s.updateMatrixWorld(!0),o.min.x=n.min.x,o.min.y=n.min.y,o.min.z=n.min.z,o.max.x=n.max.x,o.max.y=n.max.y,o.max.z=n.max.z,o)}}();const s=function(){let e={},t={};return function(i,o,s,a){n(a,void 0,void 0,t),function(e,t,i){const n=t[0],o=t[1],s=t[2],a=t[4],r=t[5],l=t[6],h=t[8],c=t[9],d=t[10],u=t[12],p=t[13],g=t[14],m=d*r-l*c,E=l*h-d*a,f=c*a-r*h,y=1/(n*m+o*E+s*f),b=m*y,v=(s*c-d*o)*y,x=(l*o-s*r)*y,T=E*y,w=(d*n-s*h)*y,R=(s*a-l*n)*y,M=f*y,H=(o*h-c*n)*y,j=(r*n-o*a)*y,D=i.x-u,A=i.y-p,S=i.z-g;e.x=b*D+T*A+M*S,e.y=v*D+w*A+H*S,e.z=x*D+R*A+j*S}(e,a,i);const r=e.x,l=e.y,h=e.z,c=o.x-r,d=o.y-l,u=o.z-h,p=r-s.x,g=l-s.y,m=h-s.z,E=Math.max(p,c)*t.x,f=Math.max(g,d)*t.y,y=Math.max(m,u)*t.z;return E<=0&&f<=0&&y<=0?Math.max(E,f,y):Math.hypot(Math.max(0,E),Math.max(0,f),Math.max(0,y))}}();function a(e,t){let i=e,n=t.slice().reverse();for(;i&&n.length>0;)i=i[n.pop()];return i}function r(e){if("object"==typeof e){if(Array.isArray(e))return e.map(r);if(e instanceof THREE.Color)return"#"+e.getHexString();if("x"in e||"y"in e||"z"in e||"w"in e)return AFRAME.utils.coordinates.stringify(e)}return e.toString()}AFRAME.registerComponent("simple-hands",{schema:{objects:{default:""},offset:{type:"vec3"},radius:{default:.05},watch:{default:!0},bubble:{default:!0},debug:{default:!1}},init(){this.observer=null,this.els=[],this.hoverEl=void 0,this.grabEl=void 0,this.sphereDebug=void 0,this.onTriggerUp=this.onTriggerUp.bind(this),this.onTriggerDown=this.onTriggerDown.bind(this)},remove(){this.pause()},play(){const e=this.el.sceneEl;this.data.watch&&(this.observer=new MutationObserver(this.update.bind(this,null)),this.observer.observe(e,{childList:!0,subtree:!0})),this.el.addEventListener("triggerdown",this.onTriggerDown),this.el.addEventListener("triggerup",this.onTriggerUp)},pause(){this.el.removeEventListener("triggerdown",this.onTriggerDown),this.el.removeEventListener("triggerup",this.onTriggerUp),this.observer&&(this.observer.disconnect(),this.observer=null)},update(e){const t=this.data;let i;if(i=t.objects?this.el.sceneEl.querySelectorAll(t.objects):this.el.sceneEl.children,(!AFRAME.utils.deepEqual(t.offset,e.offset)||t.radius!==e.radius)&&t.debug){this.sphereDebug&&this.el.object3D.remove(this.sphereDebug);let e=new THREE.SphereBufferGeometry(t.radius,6,6);e.translate(t.offset.x,t.offset.y,t.offset.z);let i=new THREE.WireframeGeometry(e);this.sphereDebug=new THREE.LineSegments(i,new THREE.LineBasicMaterial({color:16776960})),this.el.object3D.add(this.sphereDebug)}this.els=Array.prototype.slice.call(i)},tick:function(){let e=new THREE.Vector3,t=new THREE.Vector3;return function(){const i=this.data,n=this.el.object3D,o=i.radius;let a=void 0;if(!this.grabEl){let l=Number.MAX_VALUE;t.copy(i.offset).applyMatrix4(n.matrixWorld);for(let i of this.els){if(!i.isEntity||!i.object3D)continue;let n=i.object3D;if(n.boundingSphere&&n.boundingBox&&!n.boundingBox.isEmpty()||this.generateBoundingBox(n),n.boundingBox.isEmpty())continue;e.copy(n.boundingSphere.center).applyMatrix4(n.matrixWorld);const h=n.boundingSphere.radius*Math.max(n.scale.x,n.scale.y,n.scale.z);if(t.distanceTo(e)<h+o){if(s(t,n.boundingBox.min,n.boundingBox.max,n.matrixWorld.elements)<o){const e=((r=n.boundingBox).max.x-r.min.x)*(r.max.y-r.min.y)*(r.max.z-r.min.z);e<l&&(l=e,a=i)}}}}var r;this.hoverEl&&this.hoverEl!==a&&this.sendEvent(this.hoverEl,"hoverend"),a&&a!==this.hoverEl&&this.sendEvent(a,"hoverstart"),this.hoverEl=a}}(),generateBoundingBox(e){if(e.boundingBox=e.boundingBox||new THREE.Box3,e.boundingSphere=e.boundingSphere||new THREE.Sphere,o(e.boundingBox,e),!e.boundingBox.isEmpty()&&(e.boundingBox.getBoundingSphere(e.boundingSphere),this.data.debug)){let t=new THREE.Box3;t.copy(e.boundingBox),e.boundingBoxDebug=new THREE.Box3Helper(t),e.boundingBoxDebug.name="simpleHandsDebug",e.add(e.boundingBoxDebug)}},sendEvent(e,t){const i=this.data.bubble;e.emit(t,{hand:this.el},i),this.el.emit(t,{target:e},i)},onTriggerDown(e){this.hoverEl&&(this.grabEl=this.hoverEl,this.sendEvent(this.grabEl,"grabstart"))},onTriggerUp(e){this.grabEl&&(this.sendEvent(this.grabEl,"grabend"),this.grabEl=void 0)}}),console.assert("hello"===a({a:1,b:{c:{x:"hello"},d:3}},["b","c","x"])),console.assert(void 0===a({a:1,b:{c:{x:"hello"},d:3}},["b","c","y"])),console.assert(1===a({a:1,b:{c:{x:"hello"},d:3}},["a"])),console.assert(void 0===a({a:1,b:{c:{x:"hello"},d:3}},["b","w"]));const l=(()=>{const e=e=>e.trim(),t={rotation:e=>isNaN(e)?0:THREE.Math.degToRad(e),position:e=>isNaN(e)?0:e,scale:e=>isNaN(e)?1:e};return function(i,n,o){let s=t[n];if(s)return Array.isArray(o)||(o="object"==typeof o?[o.x,o.y,o.z]:o.split(" ").map(e)),o.length=3,void i.object3D[n].set(...o.map(s));const l=n.split(".");if(l.length<=2)return l[0]=l[0].replace(/[A-Z]/g,e=>"-"+e.toLowerCase()),void(o?AFRAME.utils.entity.setComponentProperty(i,l.join("."),r(o)):i.removeAttribute(l.join(".")));const h=a(i,l);h?h[part]=Array.isArray(o)&&1===o.length?o[0]:o:console.warn(`unknown path for setProperty() '${n}'`)}})(),h=function(){const e="undefined"!=typeof THREE,t=e?new THREE.Color:void 0,i=e?new THREE.Color(0,0,0):void 0,n=e=>Number(e.trim());let o=e?new THREE.Color:void 0;return function(s){if(""===s)return{type:"any",value:""};let a=s.split(" ").filter(e=>""!==e).map(n);if(!a.every(isNaN))return{type:"numbers",value:a};if(e){let e=console.warn;console.warn=(()=>{});let n=new THREE.Color(s.trim());if(n.equals(t)&&o.copy(i).setStyle(s).equals(i)&&(n=void 0),console.warn=e,n)return{type:"color",value:n}}return{type:"string",value:s.trim()}}}();function c(e){return e.trim()}function d(e){let t=e.split("..");if(t.length>1){const i=h(t[0]),n=h(t[1]);if(i.type===n.type||"any"===i.type||"any"===n.type)return{type:"any"!==i.type?i.type:n.type,range:[i.value,n.value]};console.error(`incompatible types for range ${e}`)}return{type:"string",options:e.split("|").map(c)}}function u(e,t,i){const n=t[0],o=t[1],s=(e,t)=>e===t?e:i()*(t-e)+e;if("numbers"===e){const e=Math.min(n.length,o.length);let t=o.length>e?o.slice():n.slice();for(let i=0;i<e;i++)t[i]=s(n[i],o[i]);return t}return"color"===e?new THREE.Color(s(n.r,o.r),s(n.g,o.g),s(n.b,o.b)):i()>.5?n:o}AFRAME.registerComponent("wait-set",{schema:{delay:{default:0},event:{default:""},source:{default:""},sourceScope:{default:"document",oneOf:["parent","self","document"]},target:{default:""},targetScope:{default:"document",oneOf:["parent","self","document","event"]},seed:{type:"int",default:-1}},multiple:!0,init(){this.setProperties=this.setProperties.bind(this),this.startDelay=this.startDelay.bind(this),this.eventTargetEl=void 0,this.rules={},this.sources=[],this.waitListener=function(){let e,t,i=[];function n(){if(e&&t)for(let n of i)console.log("scopedListener:remove",n.id,e),n.removeEventListener(e,t)}function o(e,t,i,n){switch(i){case"self":return""===t?[e]:e.querySelectorAll(t)||[e];case"parent":return""===t?[e]:e.parentNode.querySelectorAll(t)||[e];case"event":{const i=n||e;return""===t?[i]:i.querySelectorAll(t)||[i]}case"document":default:return""===t?[e]:document.querySelectorAll(t)||[e]}}return{set:function(s,a,r,l,h){n(),i=o(s,a,r),e=l,t=h},add:function(){if(e&&t)for(let n of i)console.log("scopedListener:add",n.id,e),n.addEventListener(e,t)},remove:n,getElementsInScope:o}}(),this.waitTimer=function(){let e,t,i,n;function o(n,o){s(),n>0?(e=setTimeout(o,1e3*n),t=Date.now(),i=o):o()}function s(){clearTimeout(self.sendEventTimer),e=void 0,t=void 0,n=void 0,i=void 0}return{start:o,stop:s,pause:function(){if(e){let e=Date.now()-t;s(),n=e}},resume:function(){n&&(o(n,i),n=void 0)}}}(),this.psuedoRandom=function(){const e=4294967295;let t=-1;function i(){return t<0?Math.random():(t=(1664525*t+1013904223)%e)/e}return{setSeed:function(e){t=e},random:i,randomInt:function(e){return~~(i()*e)},randomNumber:function(e,t){return e===t?e:i()*(t-e)+e}}}()},remove(){this.waitListener.remove(),this.waitTimer.stop()},updateSchema(e){const t=AFRAME.components[this.name].schema;let i={};for(let n in e)n in t||(i[n]={default:""});Object.keys(i).length>0&&this.extendSchema(i)},update(e){const t=AFRAME.components[this.name].schema,i=this.data;i.seed!==e.seed&&this.psuedoRandom.setSeed(i.seed);for(let e in this.rules)e in i||delete this.rules[e];for(let n in i)n in t||i[n]===e[n]||(this.rules[n]=d(i[n]));i.event===e.event&&i.source===e.source&&i.sourceScope===e.sourceScope||this.waitListener.set(this.el,i.source,i.sourceScope,i.event,this.startDelay),i.delay===e.delay||!this.delayTimer&&""!==i.event||this.startDelay()},pause(){this.waitListener.remove(),this.waitTimer.pause()},play(){this.waitTimer.resume(),this.waitListener.add()},startDelay(e){this.eventTargetEl=e?e.target:void 0,this.waitTimer.start(this.data.delay,this.setProperties)},setProperties(){const e=this.waitListener.getElementsInScope(this.el,this.data.target,this.data.targetScope,this.eventTargetEl);for(let n of e)for(let e in this.rules){let o=this.rules[e];const s=o.options?(t=o.options,i=this.psuedoRandom.random,t[Math.floor(i()*t.length)]):u(o.type,o.range,this.psuedoRandom.random);l(n,e,s)}var t,i}});const p=AFRAME.utils.debug("puzzle-3d:warn"),g=THREE.Math.radToDeg,m=THREE.Math.degToRad,E=(e,t)=>2*Math.acos(Math.abs(THREE.Math.clamp(e.dot(t),-1,1)));AFRAME.registerSystem("puzzle-3d",{schema:{goalRotation:{type:"vec3"},goalPosition:{type:"vec3"},goalMixin:{default:""},positionTolerance:{default:.05},angleTolerance:{default:20}},init(){this.pieces=new Map,this.alternatives=new Map,this.goals=new Map,this.goalPosition=new THREE.Vector3,this.goalQuaternion=new THREE.Quaternion},update(){const e=this.data;this.goalPosition.copy(e.goalPosition),this.goalQuaternion.setFromEuler(new THREE.Euler(m(e.goalRotation.x),m(e.goalRotation.y),m(e.goalRotation.z),"YXZ"))},registerPiece(e,t,i,n,o,s){i=i||this.goalPosition,n=n||this.goalQuaternion,o=o||this.data.positionTolerance,s=s||this.data.angleTolerance,this.pieces.set(e,{position:(new THREE.Vector3).copy(i),quaternion:(new THREE.Quaternion).copy(n),ghostEl:t,positionTolerance:o,angleTolerance:s,snapObj3D:void 0})},unregisterPiece(e){this.pieces.delete(e)},registerAlternatives(e,t){this.alternatives.set(e,t.map(e=>({obj3D:e,position:void 0,quaternion:void 0})))},setupGoals(e,t){this.goals.set(e,this.generateGoals(e,t))},forceSnapPiece(e){let t=this.pieces.get(e);t?(t.snapObj3D=e,t.ghostEl.object3D.visible=!1,e.position.copy(t.position),e.quaternion.copy(t.quaternion)):p("attempting to force snap an unregistered piece")},trySnapPiece(e,t){let i=this.goals.get(e);if(!i)return!1;let n=void 0;for(let e=0;e<i.length;e++){const o=i[e],s=t.position.distanceTo(o.handPosition),a=g(E(t.quaternion,o.handQuaternion));if(s<o.positionTolerance&&a<o.angleTolerance){n=o;break}}let o=this.pieces.get(e);return n&&o.snapObj3D!==n.obj3D?(o.snapObj3D&&(this.pieces.get(o.snapObj3D).ghostEl.object3D.visible=!0),this.pieces.get(n.obj3D).ghostEl.object3D.visible=!1,o.snapObj3D=n.obj3D,e.position.copy(n.position),e.quaternion.copy(n.quaternion)):!n&&o.snapObj3D&&(this.pieces.get(o.snapObj3D).ghostEl.object3D.visible=!0,o.snapObj3D=void 0),void 0!==n},generateGoals:function(){let e=new THREE.Vector3,t=new THREE.Vector3,i=new THREE.Quaternion;function n(n,o,s){let a=new THREE.Vector3,r=new THREE.Box3,l=0;return s.set(0,0,0),o.set(0,0,0),t.copy(n.position),i.copy(n.quaternion),e.copy(n.scale),n.position.set(0,0,0),n.quaternion.set(0,0,0,1),n.scale.set(1,1,1),n.updateMatrixWorld(!0),n.traverse(function(e){const t=e.geometry;if(t&&t.isBufferGeometry){const i=t.attributes.position;if(i&&i.itemSize>=3)for(let t=0,n=i.count;t<n;t++)a.fromBufferAttribute(i,t).applyMatrix4(e.matrixWorld),r.expandByPoint(a),s.add(a),l++}}),n.position.copy(t),n.quaternion.copy(i),n.scale.copy(e),n.updateMatrixWorld(!0),l>0&&s.multiplyScalar(1/l),r.isEmpty()||o.subVectors(r.max,r.min).multiplyScalar(.5).add(r.min),l>0}let o=new THREE.Matrix4,s=new THREE.Matrix4;function a(t,i,n,a,r,l){o.getInverse(t.matrixWorld).multiply(i.matrixWorld),s.compose(n,a,t.scale).multiply(o),s.decompose(r,l,e)}let r=new THREE.Matrix4,l=new THREE.Matrix4,h=new THREE.Matrix4,c=new THREE.Matrix4,d=new THREE.Matrix4,u=new THREE.Vector3,p=new THREE.Vector3,g=new THREE.Vector3,m=new THREE.Vector3,E=new THREE.Vector3;new THREE.Vector3(1,1,1);function f(t,i,o,s,a,f){return!!n(i,u,p)&&(!!n(t,g,m)&&(u.applyMatrix4(i.matrixWorld),p.applyMatrix4(i.matrixWorld),g.applyMatrix4(t.matrixWorld),m.applyMatrix4(t.matrixWorld),E.setFromMatrixColumn(i.matrixWorld,1),c.lookAt(u,p,E).scale(i.scale).setPosition(u),E.setFromMatrixColumn(t.matrixWorld,1),d.lookAt(g,m,E).scale(t.scale).setPosition(g),r.getInverse(d).multiply(t.matrixWorld).premultiply(c),l.getInverse(i.matrixWorld).multiply(r),h.compose(o,s,i.scale).multiply(l),h.decompose(a,f,e),!0))}let y=new THREE.Vector3,b=new THREE.Quaternion;return function(e,n){let o=this.pieces.get(e),s=[];a(e,n,o.position,o.quaternion,y,b),s.push({position:o.position,quaternion:o.quaternion,handPosition:(new THREE.Vector3).copy(y),handQuaternion:(new THREE.Quaternion).copy(b),positionTolerance:o.positionTolerance,angleTolerance:o.angleTolerance,obj3D:e});let r=this.alternatives.get(e);for(let o of r){const r=this.pieces.get(o.obj3D);r&&(f(e,o.obj3D,r.position,r.quaternion,t,i)&&(o.position=(new THREE.Vector3).copy(t),o.quaternion=(new THREE.Quaternion).copy(i)),o.position&&o.quaternion&&(a(e,n,o.position,o.quaternion,y,b),s.push({position:(new THREE.Vector3).copy(o.position),quaternion:(new THREE.Quaternion).copy(o.quaternion),handPosition:(new THREE.Vector3).copy(y),handQuaternion:(new THREE.Quaternion).copy(b),positionTolerance:r.positionTolerance,angleTolerance:r.angleTolerance,obj3D:o.obj3D})))}return s}}()}),AFRAME.registerComponent("puzzle-3d",{schema:{goalRotation:{type:"vec3"},goalPosition:{type:"vec3"},goalMixin:{default:""},alternatives:{type:"string"},positionTolerance:{default:.05},angleTolerance:{default:20}},multiple:!0,init(){this.state="free",this.grabHand=void 0,this.grabMatrix=new THREE.Matrix4,this.goalPosition=new THREE.Vector3,this.goalQuaternion=new THREE.Quaternion,this.goalHandPosition=new THREE.Vector3,this.goalHandQuaternion=new THREE.Quaternion,this.goalRefObj3D=void 0,this.ghostEntity=void 0,this.alternativeObjs=[],this.el.addEventListener("grabstart",this.onGrabStart.bind(this)),this.el.addEventListener("grabend",this.onGrabEnd.bind(this))},remove(){this.system.unregisterPiece(obj3D),this.el.sceneEl.removeChild(this.ghostEl)},update(e){const t=this.data;e.goalMixin!==t.goalMixin&&this.setupGhost(t.goalMixin),e.goalPosition!==t.goalPosition&&(this.ghostEl&&this.ghostEl.setAttribute("position",AFRAME.utils.coordinates.stringify(t.goalPosition)),this.goalPosition.copy(t.goalPosition)),e.goalRotation!==t.goalRotation&&(this.ghostEl&&this.ghostEl.setAttribute("rotation",AFRAME.utils.coordinates.stringify(t.goalRotation)),this.goalQuaternion.setFromEuler(new THREE.Euler(m(t.goalRotation.x),m(t.goalRotation.y),m(t.goalRotation.z),"YXZ"))),e.alternatives!==t.alternatives&&(this.alternativeObjs=t.alternatives.split(",").map(e=>e?document.querySelector(e.trim()):void 0).map(e=>e?e.object3D:void 0).filter(e=>e));const i=this.el.object3D;this.system.registerPiece(i,this.ghostEl,this.goalPosition,this.goalQuaternion,t.positionTolerance,t.angleTolerance),this.system.registerAlternatives(i,this.alternativeObjs),i&&i.position.distanceTo(this.goalPosition)<t.positionTolerance&&E(i.quaternion,this.goalQuaternion)<t.angleTolerance&&(this.setState("snap"),this.system.forceSnapPiece(i))},tick(){if(this.grabHand){const e=this.el.object3D,t=this.grabHand.object3D;this.system.trySnapPiece(e,t)?this.setState("snap"):this.setState("free"),"free"===this.state&&(e.matrix.multiplyMatrices(t.matrixWorld,this.grabMatrix),e.matrix.decompose(e.position,e.quaternion,e.scale))}},setState(e){this.state!==e&&(this.leaveState(this.state,e),this.enterState(e,this.state),this.state=e,console.log("state",e))},leaveState(e){},enterState(e){"snap"===e?this.el.emit("puzzlesnap",{},!0):"free"===e&&this.el.emit("puzzlefree",{},!0)},onGrabStart(e){this.grabHand=e.detail.hand,this.setupSnap(this.grabHand.object3D)},onGrabEnd(e){e.detail.hand===this.grabHand&&(this.grabHand=void 0)},setupGhost(e){if(this.ghostEl&&(this.el.sceneEl.removeChild(ghostEntity),this.ghostEl=void 0),e){let t=document.createElement("a-entity");this.el.sceneEl.appendChild(t),this.el.id&&t.setAttribute("id","goal-"+this.el.id),this.ghostEl=t,this.el.addEventListener("object3dset",e=>{e.target===this.el&&e.detail.type&&this.ghostEl.setObject3D(e.detail.type,this.el.getObject3D(e.detail.type).clone())}),this.el.addEventListener("object3dremove",e=>{e.target===this.el&&e.detail.type&&this.ghostEl.removeObject3D(e.detail.type)}),this.el.object3D&&(this.el.object3D.children.forEach(e=>this.ghostEl.object3D.add(e.clone)),this.ghostEl.object3DMap=this.el.object3DMap),this.ghostEl.setAttribute("scale",this.el.getAttribute("scale")),this.ghostEl.setAttribute("mixin",e)}},setupSnap(e){const t=this.el.object3D;this.grabMatrix.getInverse(e.matrixWorld).multiply(t.matrix),this.system.setupGoals(t,e)}})});